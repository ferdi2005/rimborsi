<div class="expense-row border rounded p-4 mb-4">
  <!-- Cestino in alto a destra -->
  <div class="d-flex justify-content-end mb-3">
    <button type="button" class="btn btn-danger btn-sm" onclick="removeExpense(this)">
      <i class="fas fa-trash"></i>
    </button>
    <%= f.hidden_field :_destroy %>
  </div>

  <div class="row g-3">
    <!-- Campo importo unificato -->
    <div class="col-md-3">
      <%= f.label :amount, f.object.car? ? "Importo calcolato" : "Importo spesa", class: "form-label" %>
      <div class="input-group">
        <span class="input-group-text">€</span>
        <%= f.number_field :amount, 
            step: 0.01, 
            min: 0, 
            readonly: f.object.car?, 
            class: "form-control #{'calculated-amount' if f.object.car?}", 
            placeholder: f.object.car? ? "Auto-calcolato" : "Inserisci importo",
            style: f.object.car? ? "background-color: #f8f9fa;" : "" %>
      </div>
    </div>
    
    <!-- Campo requested_amount -->
    <div class="col-md-3">
      <%= f.label :requested_amount, "Importo richiesto come rimborso", class: "form-label" %>
      <div class="input-group">
        <span class="input-group-text">€</span>
        <%= f.number_field :requested_amount, 
            step: 0.01, 
            min: 0, 
            class: "form-control", 
            placeholder: "Importo richiesto" %>
      </div>
      <small class="form-text text-muted">Eventuale importo parziale o totale richiesto</small>
    </div>
    
    <div class="col-md-3">
      <%= f.label :purpose, "Descrizione", class: "form-label" %>
      <%= f.text_field :purpose, class: "form-control", placeholder: "Descrivi la spesa..." %>
    </div>
    
    <div class="col-md-2">
      <%= f.label :date, "Data", class: "form-label" %>
      <%= f.date_field :date, class: "form-control", value: Date.current %>
    </div>

    <div class="col-md-1">
      <label class="form-label">Tipo</label>
      <div class="form-check">
        <%= f.radio_button :car, false, class: "form-check-input", id: "#{f.object_name}_car_false", checked: !f.object.car? %>
        <%= f.label :car, "Normale", class: "form-check-label", for: "#{f.object_name}_car_false" %>
      </div>
      <div class="form-check">
        <%= f.radio_button :car, true, class: "form-check-input car-type", id: "#{f.object_name}_car_true", checked: f.object.car? %>
        <%= f.label :car, "Auto", class: "form-check-label", for: "#{f.object_name}_car_true" %>
      </div>
    </div>
  </div>

  <!-- Fondo e Progetto -->
  <div class="row mt-3">
    <div class="col-md-6">
      <%= f.label :fund_id, "Fondo", class: "form-label" %>
      <%= f.select :fund_id, 
          options_from_collection_for_select(Fund.active.order(:name), :id, :name, f.object.fund_id),
          { prompt: "Seleziona fondo" },
          { class: "form-select" } %>
    </div>
    <div class="col-md-6">
      <%= f.label :project, "Progetto", class: "form-label" %>
      <%= f.text_field :project, class: "form-control", placeholder: "Nome del progetto (es. Microgrant Wiki Loves Puglia 2025)..." %>
    </div>
  </div>

  <!-- Status della spesa (solo per admin) -->
  <% if current_user.admin? %>
    <div class="row mt-4">
      <div class="col-md-3">
        <%= f.label :status, "Status", class: "form-label" %>
        <%= f.select :status, 
                    options_for_select(
                      Expense.status_translations.map { |key, value| [value, key] },
                      f.object.status
                    ), 
                    { prompt: "Seleziona status" }, 
                    { class: "form-select" } %>
      </div>
    </div>
  <% end %>

  <!-- Campo allegato per spese non auto -->
  <div class="row mt-4 attachment-field" style="<%= 'display: none;' if f.object.car? %>">
    <div class="col-md-12">
      <%= f.label :attachment, "Allegato", class: "form-label" %>
      <%= f.file_field :attachment, class: "form-control", accept: "image/*,.pdf,.xml,.xml.p7m,application/xml,text/xml,application/pkcs7-mime,application/x-pkcs7-mime"%>
      <small class="form-text text-muted">Carica ricevuta o fattura (immagine o PDF) o fattura elettronica (.xml, .xml.p7m)</small>
    </div>
  </div>

  <!-- Campi specifici per spese auto -->
  <div class="car-fields mt-4" style="<%= 'display: none;' unless f.object.car? %>">
    <div class="alert alert-info mb-4">
      <strong>Calcolo del rimborso auto</strong><br>
      Utilizza <a href="https://costikm.aci.it/" target="_blank" class="alert-link">https://costikm.aci.it/</a> per calcolare i parametri necessari.
    </div>
    
    <div class="row g-3">
      <div class="col-md-4">
        <%= f.label :calculation_date, "Data di calcolo", class: "form-label" %>
        <%= f.date_field :calculation_date, class: "form-control" %>
      </div>
      
      <div class="col-md-4">
        <%= f.label :departure, "Città di partenza", class: "form-label" %>
        <%= f.text_field :departure, class: "form-control", placeholder: "Es: Milano" %>
      </div>
      
      <div class="col-md-4">
        <%= f.label :arrival, "Città di arrivo", class: "form-label" %>
        <%= f.text_field :arrival, class: "form-control", placeholder: "Es: Roma" %>
      </div>
    </div>
    
    <div class="row g-3 mt-3">
      <div class="col-md-3">
        <%= f.label :distance, "Distanza (km)", class: "form-label" %>
        <%= f.number_field :distance, class: "form-control distance-input", min: 0.01, step: 0.01 %>
      </div>
      
      <div class="col-md-3">
        <%= f.label :vehicle_id, "Veicolo", class: "form-label" %>
        <%= f.collection_select :vehicle_id, 
                                (current_user.admin? ? Vehicle.includes(:user).all : current_user.vehicles), 
                                :id, 
                                ->(vehicle) { current_user.admin? ? "#{vehicle.display_name} (#{vehicle.user.name} #{vehicle.user.surname})" : vehicle.display_name },
                                { prompt: "Seleziona veicolo", selected: current_user.default_vehicle&.id },
                                { class: "form-select" } %>
        <small class="form-text text-muted">
          <%= link_to "Aggiungi nuovo veicolo", new_vehicle_path, target: "_blank", class: "text-decoration-none" %>
        </small>
      </div>
      
      <div class="col-md-3">
        <div class="form-check mt-4">
          <%= f.check_box :return_trip, class: "form-check-input return-trip-input" %>
          <%= f.label :return_trip, "Andata e ritorno", class: "form-check-label" %>
        </div>
      </div>
    </div>
    
    <div class="row g-3 mt-3">
      <div class="col-md-3">
        <%= f.label :quota_capitale, "Quota capitale", class: "form-label" %>
        <div class="input-group">
          <span class="input-group-text">€</span>
          <%= f.number_field :quota_capitale, step: 0.01, min: 0, class: "form-control cost-input" %>
        </div>
      </div>
      
      <div class="col-md-3">
        <%= f.label :carburante, "Quota carburante", class: "form-label" %>
        <div class="input-group">
          <span class="input-group-text">€</span>
          <%= f.number_field :carburante, step: 0.01, min: 0, class: "form-control cost-input" %>
        </div>
      </div>
      
      <div class="col-md-3">
        <%= f.label :pneumatici, "Pneumatici", class: "form-label" %>
        <div class="input-group">
          <span class="input-group-text">€</span>
          <%= f.number_field :pneumatici, step: 0.01, min: 0, class: "form-control cost-input" %>
        </div>
      </div>
      
      <div class="col-md-3">
        <%= f.label :manutenzione, "Manutenzione", class: "form-label" %>
        <div class="input-group">
          <span class="input-group-text">€</span>
          <%= f.number_field :manutenzione, step: 0.01, min: 0, class: "form-control cost-input" %>
        </div>
      </div>
    </div>
  </div>
</div>
