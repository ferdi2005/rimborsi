<div class="expense-row border rounded p-4 mb-4">
  <!-- Cestino in alto a destra -->
  <div class="d-flex justify-content-end mb-3">
    <button type="button" class="btn btn-danger btn-sm" onclick="removeExpense(this)">
      <i class="fas fa-trash"></i>
    </button>
    <%= f.hidden_field :_destroy %>
  </div>

  <div class="row g-3">
    <!-- Campo importo unificato -->
    <div class="col-md-3">
      <%= f.label :amount, class: "form-label" do %>
        <%= f.object.car? ? "Importo calcolato" : "Importo spesa" %> <span class="text-danger">*</span>
      <% end %>
      <div class="input-group">
        <span class="input-group-text">€</span>
        <%= f.number_field :amount, 
            step: 0.01, 
            min: 0, 
            readonly: f.object.car?, 
            class: "form-control #{'calculated-amount' if f.object.car?}", 
            placeholder: f.object.car? ? "Autocalcolato" : "Inserisci importo",
            style: f.object.car? ? "background-color: #f8f9fa;" : "" %>
      </div>
    </div>
    
    <!-- Campo requested_amount -->
    <div class="col-md-3">
      <%= f.label :requested_amount, class: "form-label" do %>
        Importo richiesto come rimborso <span class="text-danger">*</span>
      <% end %>
      <div class="input-group">
        <span class="input-group-text">€</span>
        <%= f.number_field :requested_amount, 
            step: 0.01, 
            min: 0, 
            class: "form-control", 
            placeholder: "Importo richiesto" %>
      </div>
      <small class="form-text text-muted">Eventuale importo parziale o totale richiesto</small>
    </div>
    
    <div class="col-md-3">
      <%= f.label :purpose, class: "form-label" do %>
        Descrizione <span class="text-danger">*</span>
      <% end %>
      <%= f.text_field :purpose, class: "form-control", placeholder: "Descrivi la spesa..." %>
    </div>
    
    <div class="col-md-2">
      <%= f.label :date, class: "form-label" do %>
        Data giustificativo <span class="text-danger">*</span>
      <% end %>
      <%= f.date_field :date, class: "form-control", value: f.object.date || Date.current %>
    </div>

    <div class="col-md-1">
      <label class="form-label">Tipo <span class="text-danger">*</span></label>
      <div class="form-check">
        <%= f.radio_button :car, false, class: "form-check-input", id: "#{f.object_name}_car_false", checked: !f.object.car? %>
        <%= f.label :car, "Normale", class: "form-check-label", for: "#{f.object_name}_car_false" %>
      </div>
      <div class="form-check">
        <%= f.radio_button :car, true, class: "form-check-input car-type", id: "#{f.object_name}_car_true", checked: f.object.car? %>
        <%= f.label :car, "Auto", class: "form-check-label", for: "#{f.object_name}_car_true" %>
      </div>
    </div>
  </div>

  <!-- Fondo e Progetto -->
  <div class="row mt-3">
    <div class="col-md-6">
      <%= f.label :fund_id, class: "form-label" do %>
        Fondo <span class="text-danger">*</span>
      <% end %>
      <%= f.select :fund_id, 
          options_from_collection_for_select(Fund.active.order(:name), :id, :name, f.object.fund_id),
          { prompt: "Seleziona fondo" },
          { class: "form-select" } %>
    </div>
    <div class="col-md-6">
      <%= f.label :project, class: "form-label" do %>
        Progetto <span class="text-danger">*</span>
      <% end %>
      <%= f.text_field :project, class: "form-control", placeholder: "Nome del progetto (es. Microgrant Wiki Loves Puglia 2025)..." %>
    </div>
  </div>

  <!-- Status della spesa (solo per admin) -->
  <% if current_user.admin? %>
    <div class="row mt-4">
      <div class="col-md-3">
        <%= f.label :status, "Status", class: "form-label" %>
        <%= f.select :status, 
                    options_for_select(
                      Expense.status_translations.map { |key, value| [value, key] },
                      f.object.status
                    ), 
                    { prompt: "Seleziona status" }, 
                    { class: "form-select" } %>
      </div>
    </div>
  <% end %>

  <!-- Campo allegato per spese non auto -->
  <div class="row mt-4 attachment-field" style="<%= 'display: none;' if f.object.car? %>">
    <div class="col-md-12">
      <%= f.label :attachment, class: "form-label" do %>
        Allegato <span class="text-danger">*</span>
      <% end %>
      
      <% if f.object.attachment.attached? && f.object.attachment.persisted? %>
        <!-- Allegato esistente -->
        <div class="alert alert-info mb-3">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <i class="<%= file_icon(f.object) %> me-2"></i>
              <div>
                <strong>File attuale:</strong> <%= f.object.attachment.filename %>
                <br>
                <small class="text-muted">
                  <%= number_to_human_size(f.object.attachment.byte_size) %> • 
                  <span class="badge <%= file_badge_class(f.object) %>">
                    <%= file_type_text(f.object) %>
                  </span>
                </small>
              </div>
            </div>
            <div class="btn-group btn-group-sm">
              <%= link_to f.object.attachment, target: "_blank", 
                          class: "btn btn-outline-primary btn-sm",
                          title: "Visualizza file" do %>
                <i class="fas fa-eye"></i>
              <% end %>
              <button type="button" class="btn btn-outline-warning btn-sm" 
                      onclick="toggleFileReplacement(this)"
                      title="Sostituisci file">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Campo nascosto per sostituire il file -->
        <div class="file-replacement-field" style="display: none;">
          <%= f.file_field :attachment, class: "form-control", accept: "image/*,.pdf,.xml,.xml.p7m,application/xml,text/xml,application/pkcs7-mime,application/x-pkcs7-mime"%>
          <small class="form-text text-muted">
            <i class="fas fa-exclamation-triangle text-warning me-1"></i>
            Carica un nuovo file per sostituire quello esistente
          </small>
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-secondary" 
                    onclick="cancelFileReplacement(this)">
              <i class="fas fa-times"></i> Annulla
            </button>
          </div>
        </div>
      <% else %>
        <!-- Nessun allegato esistente -->
        <%= f.file_field :attachment, class: "form-control", accept: "image/*,.pdf,.xml,.xml.p7m,application/xml,text/xml,application/pkcs7-mime,application/x-pkcs7-mime"%>
        <small class="form-text text-muted">Carica ricevuta o fattura (immagine o PDF) o fattura elettronica (.xml, .xml.p7m)</small>
      <% end %>
    </div>
  </div>

  <!-- Campi specifici per spese auto -->
  <div class="car-fields mt-4" style="<%= 'display: none;' unless f.object.car? %>">
    <div class="alert alert-info mb-4">
      <strong>Calcolo del rimborso auto</strong><br>
      Utilizza <a href="https://costikm.aci.it/" target="_blank" class="alert-link">https://costikm.aci.it/</a> per calcolare i parametri necessari.
    </div>
    
    <div class="row g-3">
      <div class="col-md-4">
        <%= f.label :calculation_date, class: "form-label" do %>
          Data di calcolo <span class="text-danger">*</span>
        <% end %>
        <%= f.date_field :calculation_date, class: "form-control" %>
      </div>
      
      <div class="col-md-4">
        <%= f.label :departure, class: "form-label" do %>
          Città di partenza <span class="text-danger">*</span>
        <% end %>
        <%= f.text_field :departure, class: "form-control", placeholder: "Es: Milano" %>
      </div>
      
      <div class="col-md-4">
        <%= f.label :arrival, class: "form-label" do %>
          Città di arrivo <span class="text-danger">*</span>
        <% end %>
        <%= f.text_field :arrival, class: "form-control", placeholder: "Es: Roma" %>
      </div>
    </div>
    
    <div class="row g-3 mt-3">
      <div class="col-md-3">
        <%= f.label :distance, class: "form-label" do %>
          Distanza (km) <span class="text-danger">*</span>
        <% end %>
        <%= f.number_field :distance, class: "form-control distance-input", min: 1, step: 0.1 %>
      </div>
      
      <div class="col-md-3">
        <%= f.label :vehicle_id, class: "form-label" do %>
          Veicolo <span class="text-danger">*</span>
        <% end %>
        <%= f.collection_select :vehicle_id, 
                                (current_user.admin? ? Vehicle.includes(:user).all : current_user.vehicles), 
                                :id, 
                                ->(vehicle) { current_user.admin? ? "#{vehicle.display_name} (#{vehicle.user.name} #{vehicle.user.surname})" : vehicle.display_name },
                                { prompt: "Seleziona veicolo", selected: current_user.default_vehicle&.id },
                                { class: "form-select" } %>
        <small class="form-text text-muted">
          <%= link_to "Aggiungi nuovo veicolo", new_vehicle_path, target: "_blank", class: "text-decoration-none" %>
        </small>
      </div>
      
      <div class="col-md-3">
        <div class="form-check mt-4">
          <%= f.check_box :return_trip, class: "form-check-input return-trip-input" %>
          <%= f.label :return_trip, "Andata e ritorno", class: "form-check-label" %>
        </div>
      </div>
    </div>
    
    <div class="row g-3 mt-3">
      <div class="col-md-3">
        <%= f.label :quota_capitale, class: "form-label" do %>
          Quota capitale <span class="text-danger">*</span>
        <% end %>
        <div class="input-group">
          <span class="input-group-text">€</span>
          <%= f.number_field :quota_capitale, step: 0.0001, min: 0.0001, class: "form-control cost-input" %>
        </div>
      </div>
      
      <div class="col-md-3">
        <%= f.label :carburante, class: "form-label" do %>
          Quota carburante <span class="text-danger">*</span>
        <% end %>
        <div class="input-group">
          <span class="input-group-text">€</span>
          <%= f.number_field :carburante, step: 0.0001, min: 0.0001, class: "form-control cost-input" %>
        </div>
      </div>
      
      <div class="col-md-3">
        <%= f.label :pneumatici, class: "form-label" do %>
          Pneumatici <span class="text-danger">*</span>
        <% end %>
        <div class="input-group">
          <span class="input-group-text">€</span>
          <%= f.number_field :pneumatici, step: 0.0001, min: 0.0001, class: "form-control cost-input" %>
        </div>
      </div>
      
      <div class="col-md-3">
        <%= f.label :manutenzione, class: "form-label" do %>
          Manutenzione <span class="text-danger">*</span>
        <% end %>
        <div class="input-group">
          <span class="input-group-text">€</span>
          <%= f.number_field :manutenzione, step: 0.0001, min: 0.0001, class: "form-control cost-input" %>
        </div>
      </div>
    </div>
  </div>
</div>
