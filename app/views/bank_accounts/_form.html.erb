<%= form_with(model: bank_account, class: "row g-3") do |form| %>
  <% if bank_account.errors.any? %>
    <div class="col-12">
      <div class="alert alert-danger">
        <h6><%= pluralize(bank_account.errors.count, "errore", "errori") %> ha impedito il salvataggio:</h6>
        <ul class="mb-0">
          <% bank_account.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <% if current_user.admin? %>
    <div class="col-md-6">
      <%= form.label :user_id, "Utente", class: "form-label" %>
      <%= form.collection_select :user_id, User.all, :id, 
                                ->(user) { "#{user.name} #{user.surname} (#{user.email})" }, 
                                { prompt: "Seleziona utente" }, 
                                { class: "form-select", required: true } %>
    </div>
  <% else %>
    <%= form.hidden_field :user_id, value: current_user.id %>
  <% end %>

  <div class="col-md-6">
    <%= form.label :iban, "IBAN", class: "form-label" %>
    <%= form.text_field :iban, class: "form-control", required: true,
                        pattern: "[A-Z]{2}[0-9]{2}[A-Z0-9]{1,30}",
                        title: "IBAN valido (es: IT60X0542811101000000123456)",
                        placeholder: "IT60X0542811101000000123456",
                        style: "text-transform: uppercase;" %>
    <small class="form-text text-muted">Inserisci l'IBAN senza spazi (verrà formattato automaticamente)</small>
  </div>

  <div class="col-md-6">
    <%= form.label :owner, "Intestatario", class: "form-label" %>
    <%= form.text_field :owner, class: "form-control", required: true,
                        minlength: 2, maxlength: 100 %>
    <small class="form-text text-muted">Nome completo del titolare del conto</small>
  </div>

  <div class="col-md-6">
    <%= form.label :bank_name, "Nome Banca", class: "form-label" %>
    <%= form.text_field :bank_name, class: "form-control",
                        minlength: 2, maxlength: 100,
                        placeholder: "es: Banca Intesa Sanpaolo" %>
    <small class="form-text text-muted">Nome dell'istituto bancario (opzionale)</small>
  </div>

  <div class="col-md-8">
    <%= form.label :address, "Indirizzo", class: "form-label" %>
    <%= form.text_field :address, class: "form-control" %>
  </div>

  <div class="col-md-4">
    <%= form.label :cap, "CAP", class: "form-label" %>
    <%= form.text_field :cap, class: "form-control", pattern: "[0-9]{5}", title: "CAP a 5 cifre" %>
  </div>

  <div class="col-md-6">
    <%= form.label :town, "Città", class: "form-label" %>
    <%= form.text_field :town, class: "form-control" %>
  </div>

  <div class="col-md-6">
    <%= form.label :fiscal_code, "Codice Fiscale", class: "form-label" %>
    <%= form.text_field :fiscal_code, class: "form-control", pattern: "[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]", title: "Codice fiscale italiano" %>
  </div>

  <div class="col-12">
    <div class="form-check">
      <%= form.check_box :default, class: "form-check-input" %>
      <%= form.label :default, "Conto predefinito", class: "form-check-label" %>
    </div>
    <small class="form-text text-muted">Se selezionato, questo diventerà il tuo unico conto predefinito (rimuoverà il flag da tutti gli altri conti bancari e PayPal)</small>
  </div>

  <div class="col-12">
    <%= form.submit "Salva", class: 'btn btn-primary' %>
    <%= link_to 'Annulla', bank_accounts_path, class: 'btn btn-secondary' %>
  </div>
<% end %>
