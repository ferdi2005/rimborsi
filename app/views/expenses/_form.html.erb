<%= bootstrap_form_with(model: expense) do |form| %>
<% if expense.errors.any? %>
<div id="error_explanation">
  <h2><%= pluralize(expense.errors.count, "error") %> prohibited this expense from being saved:</h2>
  <ul>
    <% expense.errors.each do |error| %>
    <li><%= error.full_message %></li>
    <% end %>
  </ul>
</div>
<% end %>
  <div class="form-group mb-3">
          <%= form.label :reimboursment_id %>
      <%= form.collection_select :reimboursment_id, Reimboursment.all, :id, :name, { prompt: true }, { class: "form-select" }  %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :purpose, class: "form-label" %>
      <%= form.text_area :purpose, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :date, class: "form-label" %>
      <%= form.date_field :date, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :amount, class: "form-label" %>
      <%= form.text_field :amount, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :car, class: "form-check-label" %>
      <%= form.check_box :car, class:"form-check-input" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :calculation_date, class: "form-label" %>
      <%= form.date_field :calculation_date, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :departure, class: "form-label" %>
      <%= form.text_field :departure, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :arrival, class: "form-label" %>
      <%= form.text_field :arrival, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :distance, class: "form-label" %>
      <%= form.number_field :distance, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :return_trip, class: "form-check-label" %>
      <%= form.check_box :return_trip, class:"form-check-input" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :veichle_category_id %>
      <%= form.collection_select :veichle_category_id, veichle_category.all, :id, :name, { prompt: true }, { class: "form-select" }  %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :brand, class: "form-label" %>
      <%= form.text_field :brand, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :model, class: "form-label" %>
      <%= form.text_field :model, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :fuel_id %>
      <%= form.collection_select :fuel_id, Fuel.all, :id, :name, { prompt: true }, { class: "form-select" }  %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :quota_capitale, class: "form-label" %>
      <%= form.text_field :quota_capitale, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :carburante, class: "form-label" %>
      <%= form.text_field :carburante, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :pneumatici, class: "form-label" %>
      <%= form.text_field :pneumatici, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :manutenzione, class: "form-label" %>
      <%= form.text_field :manutenzione, class:"form-control" %>
      </div>
  <div class="form-group mb-3">
          <%= form.label :project_id %>
      <%= form.collection_select :project_id, Project.all, :id, :name, { prompt: true }, { class: "form-select" }  %>
      </div>
  
  <!-- Allegato - mostrato solo se NON Ã¨ una spesa per auto -->
  <div class="form-group mb-3" id="attachment-field" style="<%= expense.car? ? 'display: none;' : '' %>">
    <%= form.label :attachment, "Allegato (richiesto per spese non auto)", class: "form-label" %>
    <%= form.file_field :attachment, class: "form-control", accept: "image/*,application/pdf,.doc,.docx" %>
    <% if expense.attachment.attached? %>
      <small class="form-text text-muted">
        File corrente: <%= link_to expense.attachment.filename, expense.attachment, target: "_blank" %>
      </small>
    <% end %>
  </div>

<div class="form-group mb-3">
  <%= form.submit class: 'btn btn-primary' %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const carCheckbox = document.querySelector('#expense_car');
  const attachmentField = document.querySelector('#attachment-field');
  
  function toggleAttachmentField() {
    if (carCheckbox.checked) {
      attachmentField.style.display = 'none';
      // Remove required validation when hidden
      const fileInput = attachmentField.querySelector('input[type="file"]');
      fileInput.removeAttribute('required');
    } else {
      attachmentField.style.display = 'block';
      // Add required validation when visible
      const fileInput = attachmentField.querySelector('input[type="file"]');
      if (!fileInput.files.length && !document.querySelector('small')) {
        fileInput.setAttribute('required', 'required');
      }
    }
  }
  
  // Toggle on page load
  toggleAttachmentField();
  
  // Toggle on checkbox change
  carCheckbox.addEventListener('change', toggleAttachmentField);
});
</script>
<% end %>
