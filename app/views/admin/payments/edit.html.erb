<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1><i class="fas fa-edit me-2"></i>Modifica Pagamento #<%= @payment.id %></h1>
    <%= link_to @payment, class: "btn btn-secondary" do %>
      <i class="fas fa-arrow-left me-2"></i>Torna al Pagamento
    <% end %>
  </div>

  <div class="row">
    <div class="col-md-8">
      <%= form_with(model: [:admin, @payment], local: true, class: "card") do |form| %>
        <div class="card-header">
          <h5><i class="fas fa-file-invoice me-2"></i>Dettagli Pagamento</h5>
        </div>
        <div class="card-body">
          <% if @payment.errors.any? %>
            <div class="alert alert-danger">
              <h6><i class="fas fa-exclamation-triangle me-2"></i><%= pluralize(@payment.errors.count, "errore ha", "errori hanno") %> impedito il salvataggio:</h6>
              <ul class="mb-0">
                <% @payment.errors.each do |error| %>
                  <li><%= error.full_message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="mb-3">
            <%= form.label :status, "Stato", class: "form-label" %>
            <%= form.select :status, 
                          options_for_select([
                            ['Creato', 'created']
                          ], @payment.status), 
                          {}, 
                          { class: "form-select", readonly: true } %>
            <small class="form-text text-muted">
              Lo stato può essere modificato solo tramite le azioni specifiche nella pagina di dettaglio
            </small>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="fas fa-list me-2"></i>Rimborsi Inclusi</label>
            
            <!-- Rimborsi già inclusi nel pagamento -->
            <% if @payment.reimboursements.any? %>
              <div class="alert alert-info">
                <h6><i class="fas fa-link me-2"></i>Rimborsi Attualmente Inclusi:</h6>
                <% @payment.reimboursements.each do |reimboursement| %>
                  <div class="form-check mb-2">
                    <%= check_box_tag "payment[reimboursement_ids][]", reimboursement.id, 
                                      true,
                                      { class: "form-check-input", id: "current_reimboursement_#{reimboursement.id}" } %>
                    <%= label_tag "current_reimboursement_#{reimboursement.id}", class: "form-check-label" do %>
                      <strong>Rimborso #<%= reimboursement.id %></strong> - 
                      <%= reimboursement.user.name %> <%= reimboursement.user.surname %>
                      <br>
                      <small class="text-muted">
                        <i class="fas fa-euro-sign me-1"></i>€ <%= number_with_precision(reimboursement.total_amount, precision: 2) %> |
                        <i class="fas fa-credit-card me-1"></i><%= reimboursement.bank_account.iban %> |
                        <i class="fas fa-user me-1"></i><%= reimboursement.bank_account.owner %>
                      </small>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Rimborsi disponibili da aggiungere -->
            <% if @available_reimboursements.any? %>
              <h6><i class="fas fa-plus-circle me-2"></i>Rimborsi Disponibili da Aggiungere:</h6>
              <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                <% @available_reimboursements.each do |reimboursement| %>
                  <div class="form-check mb-2">
                    <%= check_box_tag "payment[reimboursement_ids][]", reimboursement.id, 
                                      false,
                                      { class: "form-check-input", id: "available_reimboursement_#{reimboursement.id}" } %>
                    <%= label_tag "available_reimboursement_#{reimboursement.id}", class: "form-check-label" do %>
                      <strong>Rimborso #<%= reimboursement.id %></strong> - 
                      <%= reimboursement.user.name %> <%= reimboursement.user.surname %>
                      <br>
                      <small class="text-muted">
                        <i class="fas fa-euro-sign me-1"></i>€ <%= number_with_precision(reimboursement.total_amount, precision: 2) %> |
                        <i class="fas fa-credit-card me-1"></i><%= reimboursement.bank_account.iban %> |
                        <i class="fas fa-user me-1"></i><%= reimboursement.bank_account.owner %>
                      </small>
                    <% end %>
                  </div>
                <% end %>
              </div>
              <small class="form-text text-muted">
                Puoi aggiungere o rimuovere rimborsi approvati da questo pagamento finché non è marcato come "Pagato".
              </small>
            <% else %>
              <% unless @payment.reimboursements.any? %>
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Nessun rimborso disponibile</strong><br>
                  Non ci sono altri rimborsi approvati con conti bancari disponibili da aggiungere.
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
        <div class="card-footer">
          <%= form.submit "Aggiorna Pagamento", class: "btn btn-primary" %>
          <%= link_to "Annulla", @payment, class: "btn btn-secondary" %>
        </div>
      <% end %>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h6><i class="fas fa-info-circle me-2"></i>Informazioni Pagamento</h6>
        </div>
        <div class="card-body">
          <p class="small">
            <strong>ID Pagamento:</strong> #<%= @payment.id %><br>
            <strong>Stato:</strong> 
            <span class="badge bg-<%= @payment.created? ? 'warning' : 'success' %>">
              <%= @payment.status.humanize %>
            </span><br>
            <strong>Creato il:</strong> <%= @payment.created_at.strftime("%d/%m/%Y alle %H:%M") %><br>
            <% if @payment.payment_date.present? %>
              <strong>Data Pagamento:</strong> <%= @payment.payment_date.strftime("%d/%m/%Y") %><br>
            <% end %>
          </p>
          
          <hr>
          
          <p class="small">
            <strong>Totale Attuale:</strong><br>
            €<%= number_with_precision(@payment.total_amount, precision: 2) %>
            <% if @payment.reimboursements.any? %>
              <br><small class="text-muted">
                (<%= @payment.reimboursements.count %> rimborsi)
              </small>
            <% end %>
          </p>
          
          <% if @available_reimboursements.any? %>
            <hr>
            <p class="small">
              <strong>Disponibili da Aggiungere:</strong><br>
              <%= @available_reimboursements.count %> rimborsi per €<%= number_with_precision(@available_reimboursements.sum(&:total_amount), precision: 2) %>
            </p>
          <% end %>
          
          <hr>
          
          <p class="small">
            <strong>Nota:</strong><br>
            Puoi modificare i rimborsi inclusi solo finché il pagamento è nello stato "Creato". 
            Una volta marcato come "Pagato", non sarà più modificabile.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('input[name="payment[reimboursement_ids][]"]');
  const currentTotal = <%= @payment.total_amount %>;
  
  const updateTotal = () => {
    let total = 0;
    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        const label = document.querySelector(`label[for="${checkbox.id}"]`);
        const amountText = label.textContent.match(/€\s*([\d,]+\.?\d*)/);
        if (amountText) {
          total += parseFloat(amountText[1].replace(',', ''));
        }
      }
    });
    
    // Aggiorna o crea l'elemento totale
    let totalElement = document.getElementById('selected-total');
    if (!totalElement) {
      totalElement = document.createElement('div');
      totalElement.id = 'selected-total';
      totalElement.className = 'alert alert-info mt-3';
      document.querySelector('.card-body').appendChild(totalElement);
    }
    
    const difference = total - currentTotal;
    let message = `<i class="fas fa-calculator me-2"></i><strong>Nuovo Totale:</strong> €${total.toFixed(2)}`;
    
    if (difference !== 0) {
      const diffClass = difference > 0 ? 'text-success' : 'text-danger';
      const diffIcon = difference > 0 ? 'fas fa-plus' : 'fas fa-minus';
      message += `<br><small class="${diffClass}">
        <i class="${diffIcon} me-1"></i>
        ${difference > 0 ? '+' : ''}€${difference.toFixed(2)} rispetto al totale attuale
      </small>`;
    }
    
    totalElement.innerHTML = message;
    totalElement.style.display = 'block';
  };
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateTotal);
  });
  
  updateTotal(); // Calcolo iniziale
});
</script>
